name: "Update documentation in gh-pages"

inputs:
  username:
    description: "GitHub username"
    required: true
  email:
    description: "GitHub email"
    required: true
  token:
    description: "GitHub Token (must be a PAT for repository dispatch)"
    required: true
  tag:
    description: "Version tag to be deployed by mike"
    required: true

runs:
  using: "composite"
  steps:
    - name: Set up Python
      uses: actions/setup-python@v1
      with:
        python-version: 3.11

    - name: Set up Poetry
      uses: abatilo/actions-poetry@v2
      with:
        poetry-version: "1.8.2"

    - name: Install dependencies
      shell: bash
      run: |
        cd docs
        poetry install

   # - name: Install packages
   #   shell: bash
   #   run: |
    #    pip install -r ./docs/requirements.txt
    - name: Update documentation branch with mike
      shell: bash
      env:
        NEW_TAG: ${{ inputs.tag }}
      run: |
        git config --local user.name  ${{ inputs.username }}
        git config --local user.email ${{ inputs.email }}
        git config --local user.password ${{ inputs.token }}
        git fetch origin gh-pages

        if [ -z "$NEW_TAG" ]; then
          mike deploy dev --push --rebase --config-file ./docs/mkdocs.yml
        else
          new_tag=${NEW_TAG%.*}
          mike deploy "$new_tag" latest --update-aliases --push --rebase --config-file ./docs/mkdocs.yml
        fi
