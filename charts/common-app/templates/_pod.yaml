{{- define "common-app.pod" -}}
{{- $root := . -}}
metadata:
{{- if or .Values.podAnnotations .Values.files }}
  annotations:
  {{- if .Values.files }}
    checksum/config: {{ include (print $.Template.BasePath "/configmap.yaml") . | sha256sum }}
  {{- end }}
  {{- range $key, $value := .Values.podAnnotations }}
    {{ $key | quote }}: {{ $value | quote }}
  {{- end }}
{{- end }}
  labels:
    {{- include "common-app.selectorLabels" . | nindent 4 }}
    streams-bootstrap/kind: {{ .Chart.Name }}
    {{- range $key, $value := .Values.podLabels }}
    {{ $key }}: {{ $value }}
    {{- end }}
spec:
  {{- if .Values.serviceAccountName }}
  serviceAccountName: {{ .Values.serviceAccountName }}
  {{- end }}
  {{- if .Values.tolerations }}
  tolerations:
{{ toYaml .Values.tolerations | indent 4 }}
  {{- end }}
  {{- with .Values.affinity }}
  affinity:
    {{- tpl (toYaml .) $root | nindent 4 }}
  {{- end }}
  {{- if .Values.priorityClassName }}
  priorityClassName: {{ .Values.priorityClassName }}
  {{- end }}
  terminationGracePeriodSeconds: {{ .Values.terminationGracePeriodSeconds }}
  {{- if .Values.imagePullSecrets }}
  imagePullSecrets:
{{- toYaml .Values.imagePullSecrets | nindent 4 }}
  {{- end }}
  containers:
    - name: "kafka-app"
      image: "{{ .Values.image }}:{{ .Values.imageTag }}"
      imagePullPolicy: "{{ .Values.imagePullPolicy }}"
      resources:
{{ toYaml .Values.resources | indent 8 }}
      env:
      {{- include "common-app.common-env" . | nindent 8 }}
      {{- range .Values.ports }}
        {{- if .servicePort }} # TODO verify that there is at most one service port. Currently, if there are multiple service ports, the first one will be used
        - name: POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        - name: KAFKA_APPLICATION_SERVER
          value: "$(POD_IP):{{ .containerPort }}"
        {{- end }}
      {{- end }}
      {{- if .Values.kafka.staticMembership }}
        - name: KAFKA_GROUP_INSTANCE_ID
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
      {{- end }}
      {{- if not .Values.statefulSet }}
        - name: "{{ .Values.configurationEnvPrefix }}_VOLATILE_GROUP_INSTANCE_ID"
          value: "true"
      {{- end }}
      {{- if and (hasKey .Values.kafka "inputTopics") (.Values.kafka.inputTopics) }}
        - name: "{{ .Values.configurationEnvPrefix }}_INPUT_TOPICS"
          value: {{ .Values.kafka.inputTopics | join "," | quote }}
      {{- end }}
      {{- if hasKey .Values.kafka "inputPattern" }}
        - name: "{{ .Values.configurationEnvPrefix }}_INPUT_PATTERN"
          value: {{ .Values.kafka.inputPattern | quote }}
      {{- end }}
      {{- if hasKey .Values.kafka "outputTopic" }}
        - name: "{{ .Values.configurationEnvPrefix }}_OUTPUT_TOPIC"
          value: {{ .Values.kafka.outputTopic | quote }}
      {{- end }}
      {{- if hasKey .Values.kafka "errorTopic" }}
        - name: "{{ .Values.configurationEnvPrefix }}_ERROR_TOPIC"
          value: {{ .Values.kafka.errorTopic | quote }}
      {{- end }}
      {{- if and (hasKey .Values.kafka "labeledOutputTopics") (.Values.kafka.labeledOutputTopics) }}
        - name: "{{ .Values.configurationEnvPrefix }}_LABELED_OUTPUT_TOPICS"
          value: "{{- range $key, $value := .Values.kafka.labeledOutputTopics }}{{ $key }}={{ $value }},{{- end }}"
      {{- end }}
      {{- $delimiter := ";" }}
      {{- if and (hasKey .Values.kafka "labeledInputTopics") (.Values.kafka.labeledInputTopics) }}
        - name: "{{ .Values.configurationEnvPrefix }}_LABELED_INPUT_TOPICS"
          value: "{{- range $key, $value := .Values.kafka.labeledInputTopics }}{{ $key }}={{ $value | join $delimiter }},{{- end }}"
      {{- end }}
      {{- if and (hasKey .Values.kafka "labeledInputPatterns") (.Values.kafka.labeledInputPatterns) }}
        - name: "{{ .Values.configurationEnvPrefix }}_LABELED_INPUT_PATTERNS"
          value: "{{- range $key, $value := .Values.kafka.labeledInputPatterns }}{{ $key }}={{ $value }},{{- end }}"
      {{- end }}
      {{- if hasKey .Values.kafka "applicationId" }}
        - name: "{{ .Values.configurationEnvPrefix }}_APPLICATION_ID"
          value: {{ .Values.kafka.applicationId | quote }}
      {{- end }}
      {{- if hasKey .Values.kafka "groupId" }}
        - name: "{{ .Values.configurationEnvPrefix }}_GROUP_ID"
          value: {{ .Values.kafka.groupId | quote }}
      {{- end }}
        - name: JAVA_TOOL_OPTIONS
          value: '-Dcom.sun.management.jmxremote.port={{ .Values.jmx.port }}
            -Dcom.sun.management.jmxremote.authenticate=false
            -Dcom.sun.management.jmxremote.ssl=false
            {{- if .Values.jmx.enabled }}
            -Djava.rmi.server.hostname={{ .Values.jmx.host }}
            -Dcom.sun.management.jmxremote.rmi.port={{ .Values.jmx.port }}
            {{- end }}
            -XX:MaxRAMPercentage={{ printf "%.1f" .Values.javaOptions.maxRAMPercentage }}
            {{ .Values.javaOptions.others | join " " }}'
    {{- if or (.Values.files) (and .Values.persistence.enabled .Values.statefulSet) (.Values.secretFilesRefs) }}
      volumeMounts:
        {{- include "common-app.volume-mounts" . | nindent 8 }}
        {{- if and .Values.persistence.enabled .Values.statefulSet }}
        - name: datadir
          mountPath: /tmp/kafka-streams
        {{- end }}
    {{- end }}
    {{- if or (.Values.jmx.enabled) (.Values.ports) }}
      ports:
        {{- range .Values.ports }}
        - containerPort: {{ .containerPort }}
          name: {{ .name | quote }}
          {{- if .protocol }}
          protocol: {{ .protocol | quote }}
          {{- end }}
        {{- end }}
        {{- if .Values.jmx.enabled }}
        - containerPort: {{ .Values.jmx.port }}
          name: jmx
        {{- end }}
    {{- end }}
      {{- if .Values.livenessProbe }}
      livenessProbe:
      {{- .Values.livenessProbe | toYaml | nindent 8 }}
      {{- end }}
      {{- if .Values.readinessProbe }}
      readinessProbe:
      {{- .Values.readinessProbe | toYaml | nindent 8 }}
      {{- end }}
  {{- if .Values.prometheus.jmx.enabled }}
    - name: prometheus-jmx-exporter
      image: "{{ .Values.prometheus.jmx.image }}:{{ .Values.prometheus.jmx.imageTag }}"
      imagePullPolicy: "{{ .Values.prometheus.jmx.imagePullPolicy }}"
      args:
        - {{ .Values.prometheus.jmx.port | quote }}
        - /etc/jmx-{{ .Chart.Name }}/jmx-kafka-{{ .Chart.Name }}-prometheus.yml
      env:
        - name: JAVA_TOOL_OPTIONS
          value: "-XX:MaxRAMPercentage=90.0"
      ports:
        - containerPort: {{ .Values.prometheus.jmx.port }}
          name: prometheus
      resources:
{{ toYaml .Values.prometheus.jmx.resources | indent 8 }}
      volumeMounts:
        - name: jmx-config
          mountPath: /etc/jmx-{{ .Chart.Name }}
  {{- end }}
  {{- if or (.Values.prometheus.jmx.enabled) (.Values.files) (.Values.secretFilesRefs) }}
  volumes:
    {{- if .Values.prometheus.jmx.enabled }}
    - name: jmx-config
      configMap:
        name: {{ include "common-app.fullname" . }}-jmx
    {{- end }}
    {{- include "common-app.volumes" . | nindent 4 }}
  {{- end }}
{{- end -}}
